<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Humanity Badge - Manual Test Runner</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }

        h1 {
            color: #1c1c1c;
            text-align: center;
            border-bottom: 3px solid #ff4500;
            padding-bottom: 10px;
        }

        .test-section {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .test-section h2 {
            color: #0079d3;
            margin-top: 0;
        }

        .test-status {
            position: fixed;
            top: 10px;
            right: 10px;
            background: #0079d3;
            color: white;
            padding: 15px;
            border-radius: 8px;
            font-weight: bold;
            min-width: 200px;
            text-align: center;
        }

        .test-passed {
            background: #46d160;
        }

        .test-failed {
            background: #ff4444;
        }

        .test-warning {
            background: #ff8c00;
        }

        .test-result {
            margin: 10px 0;
            padding: 10px;
            border-radius: 4px;
            font-weight: bold;
        }

        .result-pass {
            background: #e8f5e8;
            color: #2e7d32;
            border-left: 4px solid #4CAF50;
        }

        .result-fail {
            background: #ffebee;
            color: #c62828;
            border-left: 4px solid #f44336;
        }

        .result-info {
            background: #e3f2fd;
            color: #1565c0;
            border-left: 4px solid #2196f3;
        }

        .test-controls {
            text-align: center;
            margin: 20px 0;
        }

        .test-controls button {
            background: #0079d3;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            font-size: 16px;
            cursor: pointer;
            margin: 0 10px;
            transition: background-color 0.2s;
        }

        .test-controls button:hover {
            background: #005fa3;
        }

        .test-controls button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        textarea, input[type="text"] {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-family: inherit;
            margin: 10px 0;
            transition: border-color 0.2s;
        }

        textarea:focus, input[type="text"]:focus {
            outline: none;
            border-color: #0079d3;
            box-shadow: 0 0 0 3px rgba(0,121,211,0.1);
        }

        .log-container {
            max-height: 300px;
            overflow-y: auto;
            background: #f8f9fa;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 10px;
            font-family: 'Monaco', 'Menlo', 'Consolas', monospace;
            font-size: 12px;
        }

        .log-entry {
            margin: 2px 0;
            padding: 2px 0;
        }

        .log-error {
            color: #d32f2f;
        }

        .log-success {
            color: #388e3c;
        }

        .log-info {
            color: #1976d2;
        }

        .performance-metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .metric {
            background: #f0f0f0;
            padding: 15px;
            border-radius: 6px;
            text-align: center;
        }

        .metric-value {
            font-size: 24px;
            font-weight: bold;
            color: #0079d3;
        }

        .metric-label {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <h1>🧪 Humanity Badge Extension - Manual Test Runner</h1>
    
    <div class="test-status" id="overallStatus">
        Initializing Tests...
    </div>

    <div class="test-section">
        <h2>Extension Status</h2>
        <div id="extensionStatus" class="result-info">
            Checking extension loading...
        </div>
        
        <div class="performance-metrics">
            <div class="metric">
                <div class="metric-value" id="elementsFound">0</div>
                <div class="metric-label">Elements Found</div>
            </div>
            <div class="metric">
                <div class="metric-value" id="buttonsAttached">0</div>
                <div class="metric-label">Buttons Attached</div>
            </div>
            <div class="metric">
                <div class="metric-value" id="testsPassed">0</div>
                <div class="metric-label">Tests Passed</div>
            </div>
            <div class="metric">
                <div class="metric-value" id="testsFailed">0</div>
                <div class="metric-label">Tests Failed</div>
            </div>
        </div>
    </div>

    <div class="test-section">
        <h2>Manual Testing Controls</h2>
        <div class="test-controls">
            <button onclick="runAllTests()">Run All Tests</button>
            <button onclick="testBasicFunctionality()">Test Basic Functions</button>
            <button onclick="testRedditSelectors()">Test Reddit Selectors</button>
            <button onclick="testPastePrevention()">Test Paste Prevention</button>
            <button onclick="clearResults()">Clear Results</button>
        </div>
    </div>

    <div class="test-section">
        <h2>Test Textarea - Basic Functionality</h2>
        <p>This textarea should have a Humanity Badge button attached:</p>
        <textarea placeholder="Start typing here to test basic functionality..." rows="4"></textarea>
        <div id="basicTest" class="test-result result-info">Waiting for test...</div>
    </div>

    <div class="test-section">
        <h2>Test Textarea - Reddit Simulation</h2>
        <p>This simulates Reddit's comment form:</p>
        <div data-testid="comment-submission-form-richtext">
            <textarea placeholder="What are your thoughts? (Reddit simulation)" rows="4"></textarea>
        </div>
        <div id="redditTest" class="test-result result-info">Waiting for test...</div>
    </div>

    <div class="test-section">
        <h2>Test ContentEditable - Rich Text</h2>
        <p>This simulates Reddit's rich text editor:</p>
        <div contenteditable="true" 
             data-testid="rich-text-editor"
             style="min-height: 100px; border: 2px solid #ddd; padding: 12px; border-radius: 6px; background: white;">
            Click here and start typing to test rich text editing...
        </div>
        <div id="richTextTest" class="test-result result-info">Waiting for test...</div>
    </div>

    <div class="test-section">
        <h2>Paste Prevention Test</h2>
        <p>Try to paste content into this textarea (should be blocked during recording):</p>
        <textarea id="pasteTestArea" placeholder="Try pasting here during recording..." rows="3"></textarea>
        <div>
            <button onclick="startPasteTest()">Start Recording (Paste Blocked)</button>
            <button onclick="stopPasteTest()">Stop Recording</button>
        </div>
        <div id="pasteTestResult" class="test-result result-info">Click "Start Recording" then try to paste content</div>
    </div>

    <div class="test-section">
        <h2>Performance Test</h2>
        <p>Type quickly in this textarea to test performance:</p>
        <textarea id="performanceTest" placeholder="Type quickly here to test performance and throttling..." rows="4"></textarea>
        <div id="performanceResult" class="test-result result-info">Start typing to see performance metrics</div>
    </div>

    <div class="test-section">
        <h2>Debug Information</h2>
        <div class="log-container" id="debugLog">
            <div class="log-entry log-info">Debug log initialized...</div>
        </div>
    </div>

    <script>
        // Test state management
        let testResults = {
            extensionLoaded: false,
            buttonsAttached: 0,
            elementsFound: 0,
            basicFunctionality: false,
            redditSelectors: false,
            richTextEditor: false,
            pastePrevention: false,
            performance: false,
            testsPassed: 0,
            testsFailed: 0
        };

        // Debug logging
        function logDebug(message, type = 'info') {
            const logContainer = document.getElementById('debugLog');
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry log-${type}`;
            logEntry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;
            
            console.log(`HumanityBadge Test: ${message}`);
        }

        // Update display metrics
        function updateMetrics() {
            document.getElementById('elementsFound').textContent = testResults.elementsFound;
            document.getElementById('buttonsAttached').textContent = testResults.buttonsAttached;
            document.getElementById('testsPassed').textContent = testResults.testsPassed;
            document.getElementById('testsFailed').textContent = testResults.testsFailed;
        }

        // Update overall status
        function updateStatus() {
            const status = document.getElementById('overallStatus');
            const extensionStatus = document.getElementById('extensionStatus');
            
            if (testResults.extensionLoaded) {
                extensionStatus.textContent = '✅ Extension loaded and working';
                extensionStatus.className = 'test-result result-pass';
                
                const totalTests = 6;
                const passedTests = testResults.testsPassed;
                
                status.textContent = `Tests: ${passedTests}/${totalTests} passed`;
                
                if (passedTests === totalTests) {
                    status.className = 'test-status test-passed';
                } else if (passedTests > totalTests / 2) {
                    status.className = 'test-status test-warning';
                } else {
                    status.className = 'test-status test-failed';
                }
            } else {
                extensionStatus.textContent = '❌ Extension not detected - check if loaded';
                extensionStatus.className = 'test-result result-fail';
                status.textContent = 'Extension not loaded';
                status.className = 'test-status test-failed';
            }
            
            updateMetrics();
        }

        // Test basic functionality
        function testBasicFunctionality() {
            logDebug('Testing basic functionality...', 'info');
            
            const textareas = document.querySelectorAll('textarea');
            const buttons = document.querySelectorAll('.typing-record-btn');
            
            testResults.elementsFound = textareas.length;
            testResults.buttonsAttached = buttons.length;
            
            const basicTestResult = document.getElementById('basicTest');
            
            if (buttons.length > 0) {
                testResults.basicFunctionality = true;
                testResults.testsPassed++;
                basicTestResult.textContent = '✅ Basic functionality working - buttons attached';
                basicTestResult.className = 'test-result result-pass';
                logDebug('Basic functionality test passed', 'success');
            } else {
                testResults.testsFailed++;
                basicTestResult.textContent = '❌ Basic functionality failed - no buttons found';
                basicTestResult.className = 'test-result result-fail';
                logDebug('Basic functionality test failed - no buttons attached', 'error');
            }
            
            updateStatus();
        }

        // Test Reddit selectors
        function testRedditSelectors() {
            logDebug('Testing Reddit selectors...', 'info');
            
            const redditElements = document.querySelectorAll('[data-testid="comment-submission-form-richtext"]');
            const redditButtons = document.querySelectorAll('[data-testid="comment-submission-form-richtext"] ~ .typing-record-btn, [data-testid="comment-submission-form-richtext"] .typing-record-btn');
            
            const redditTestResult = document.getElementById('redditTest');
            
            if (redditElements.length > 0 && redditButtons.length > 0) {
                testResults.redditSelectors = true;
                testResults.testsPassed++;
                redditTestResult.textContent = '✅ Reddit selectors working';
                redditTestResult.className = 'test-result result-pass';
                logDebug('Reddit selectors test passed', 'success');
            } else {
                testResults.testsFailed++;
                redditTestResult.textContent = '❌ Reddit selectors failed';
                redditTestResult.className = 'test-result result-fail';
                logDebug(`Reddit selectors test failed - elements: ${redditElements.length}, buttons: ${redditButtons.length}`, 'error');
            }
            
            updateStatus();
        }

        // Test paste prevention
        let pasteTestRecording = false;
        
        function startPasteTest() {
            const button = document.querySelector('.typing-record-btn');
            if (button) {
                button.click();
                pasteTestRecording = true;
                logDebug('Started paste test recording', 'info');
            }
        }
        
        function stopPasteTest() {
            const stopButton = document.getElementById('stop-recording');
            if (stopButton) {
                stopButton.click();
            }
            pasteTestRecording = false;
            logDebug('Stopped paste test recording', 'info');
        }
        
        function testPastePrevention() {
            logDebug('Testing paste prevention...', 'info');
            
            const pasteArea = document.getElementById('pasteTestArea');
            let pasteBlocked = false;
            
            // Add a test paste event
            pasteArea.addEventListener('paste', (e) => {
                if (pasteTestRecording) {
                    pasteBlocked = true;
                    logDebug('Paste event detected during recording', 'info');
                }
            });
            
            const pasteResult = document.getElementById('pasteTestResult');
            pasteResult.textContent = '🔄 Start recording and try pasting to test';
            pasteResult.className = 'test-result result-info';
        }

        // Performance monitoring
        function setupPerformanceTest() {
            const perfTextarea = document.getElementById('performanceTest');
            let eventCount = 0;
            let startTime = Date.now();
            
            perfTextarea.addEventListener('input', () => {
                eventCount++;
                const elapsed = Date.now() - startTime;
                const eventsPerSecond = Math.round((eventCount / elapsed) * 1000);
                
                const perfResult = document.getElementById('performanceResult');
                perfResult.textContent = `⚡ Events: ${eventCount}, Rate: ${eventsPerSecond}/sec`;
                perfResult.className = 'test-result result-info';
                
                if (eventsPerSecond > 0 && eventsPerSecond < 100) {
                    testResults.performance = true;
                    if (!testResults.performance) {
                        testResults.testsPassed++;
                        logDebug('Performance test passed', 'success');
                    }
                }
            });
        }

        // Run all tests
        function runAllTests() {
            logDebug('Running all tests...', 'info');
            clearResults();
            
            setTimeout(() => testBasicFunctionality(), 100);
            setTimeout(() => testRedditSelectors(), 200);
            setTimeout(() => testPastePrevention(), 300);
            
            logDebug('All automatic tests completed', 'success');
        }

        // Clear test results
        function clearResults() {
            testResults.testsPassed = 0;
            testResults.testsFailed = 0;
            
            document.getElementById('basicTest').textContent = 'Waiting for test...';
            document.getElementById('basicTest').className = 'test-result result-info';
            
            document.getElementById('redditTest').textContent = 'Waiting for test...';
            document.getElementById('redditTest').className = 'test-result result-info';
            
            logDebug('Test results cleared', 'info');
            updateStatus();
        }

        // Initialize extension detection
        function detectExtension() {
            logDebug('Detecting extension...', 'info');
            
            let checkCount = 0;
            const maxChecks = 50;
            
            const checkInterval = setInterval(() => {
                const buttons = document.querySelectorAll('.typing-record-btn');
                const textareas = document.querySelectorAll('textarea');
                
                testResults.elementsFound = textareas.length;
                testResults.buttonsAttached = buttons.length;
                
                if (buttons.length > 0) {
                    testResults.extensionLoaded = true;
                    clearInterval(checkInterval);
                    logDebug(`Extension detected! Found ${buttons.length} buttons`, 'success');
                    updateStatus();
                    
                    // Run initial tests
                    setTimeout(runAllTests, 500);
                } else {
                    checkCount++;
                    if (checkCount >= maxChecks) {
                        clearInterval(checkInterval);
                        logDebug('Extension not detected after timeout', 'error');
                        updateStatus();
                    }
                }
                
                updateMetrics();
            }, 200);
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', () => {
            logDebug('Test runner initialized', 'info');
            setupPerformanceTest();
            
            // Start extension detection
            setTimeout(detectExtension, 100);
            
            // Monitor for paste blocked messages
            const observer = new MutationObserver((mutations) => {
                mutations.forEach((mutation) => {
                    mutation.addedNodes.forEach((node) => {
                        if (node.classList && node.classList.contains('paste-blocked-message')) {
                            testResults.pastePrevention = true;
                            testResults.testsPassed++;
                            
                            const pasteResult = document.getElementById('pasteTestResult');
                            pasteResult.textContent = '✅ Paste prevention working';
                            pasteResult.className = 'test-result result-pass';
                            
                            logDebug('Paste blocked message detected', 'success');
                            updateStatus();
                        }
                    });
                });
            });
            
            observer.observe(document.body, {
                childList: true,
                subtree: true
            });
        });

        // Global error handling
        window.addEventListener('error', (event) => {
            logDebug(`Error: ${event.error.message}`, 'error');
        });

        // Console override for debugging
        const originalLog = console.log;
        console.log = function(...args) {
            originalLog.apply(console, args);
            if (args[0] && args[0].includes && args[0].includes('HumanityBadge')) {
                logDebug(args.join(' '), 'info');
            }
        };
    </script>
</body>
</html>