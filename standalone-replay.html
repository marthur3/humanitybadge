<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Humanity Badge - Typing Replay</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Open Graph tags for social media sharing -->
  <meta property="og:title" content="Humanity Badge - Verified Human Typing">
  <meta property="og:description" content="Authentic human typing verified with Humanity Badge">
  <meta property="og:type" content="website">

  <style>
    * {
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      margin: 0;
      padding: 20px;
      background: #f5f5f5;
    }

    .replay-container {
      max-width: 800px;
      margin: 0 auto;
      background: white;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      overflow: hidden;
    }

    .replay-header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 20px;
      text-align: center;
    }

    .replay-header h1 {
      margin: 0 0 10px 0;
      font-size: 24px;
    }

    .replay-info {
      display: flex;
      justify-content: center;
      gap: 20px;
      font-size: 14px;
      opacity: 0.9;
      flex-wrap: wrap;
    }

    .verification-badge {
      display: inline-block;
      background: rgba(255, 255, 255, 0.2);
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 14px;
      font-weight: 600;
      margin-top: 10px;
    }

    .verification-badge.verified {
      background: rgba(76, 175, 80, 0.3);
    }

    .verification-badge.failed {
      background: rgba(244, 67, 54, 0.3);
    }

    .replay-controls {
      padding: 20px;
      display: flex;
      align-items: center;
      gap: 10px;
      border-bottom: 1px solid #eee;
      flex-wrap: wrap;
    }

    .replay-controls button {
      padding: 10px 15px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px;
      background: #4CAF50;
      color: white;
      transition: background 0.2s;
    }

    .replay-controls button:hover:not(:disabled) {
      background: #45a049;
    }

    .replay-controls button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }

    .speed-controls {
      margin-left: auto;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .speed-controls select {
      padding: 5px;
      border: 1px solid #ddd;
      border-radius: 3px;
    }

    .progress-container {
      padding: 0 20px 20px;
    }

    .progress-bar {
      width: 100%;
      height: 8px;
      background: #e0e0e0;
      border-radius: 4px;
      overflow: hidden;
      margin-bottom: 10px;
    }

    #progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #4CAF50, #45a049);
      width: 0%;
      transition: width 0.1s linear;
    }

    .time-info {
      display: flex;
      justify-content: space-between;
      font-size: 12px;
      color: #666;
    }

    .replay-area {
      padding: 20px;
      background: #fafafa;
    }

    .textarea-container {
      position: relative;
    }

    #replay-textarea {
      width: 100%;
      min-height: 200px;
      padding: 15px;
      border: 2px solid #ddd;
      border-radius: 8px;
      font-family: monospace;
      font-size: 14px;
      line-height: 1.4;
      resize: vertical;
      background: white;
    }

    #cursor {
      position: absolute;
      width: 2px;
      height: 20px;
      background: #333;
      animation: blink 1s infinite;
      pointer-events: none;
      display: none;
    }

    @keyframes blink {
      0%, 50% { opacity: 1; }
      51%, 100% { opacity: 0; }
    }

    .replay-stats {
      padding: 20px;
      display: flex;
      justify-content: space-around;
      background: #f9f9f9;
      border-top: 1px solid #eee;
      flex-wrap: wrap;
      gap: 15px;
    }

    .stat {
      text-align: center;
    }

    .stat label {
      display: block;
      font-size: 12px;
      color: #666;
      margin-bottom: 5px;
    }

    .stat span {
      font-size: 18px;
      font-weight: bold;
      color: #333;
    }

    .replay-footer {
      padding: 20px;
      background: #f0f0f0;
      text-align: center;
    }

    .footer-info {
      font-size: 14px;
      color: #666;
      margin-bottom: 15px;
    }

    .get-extension-btn {
      display: inline-block;
      padding: 12px 24px;
      background: linear-gradient(135deg, #4CAF50, #45a049);
      color: white;
      text-decoration: none;
      border-radius: 6px;
      font-weight: 600;
      transition: transform 0.2s;
    }

    .get-extension-btn:hover {
      transform: scale(1.05);
    }

    .error {
      text-align: center;
      padding: 40px;
      color: #f44336;
      background: #ffebee;
      margin: 20px;
      border-radius: 5px;
    }

    @media (max-width: 600px) {
      body {
        padding: 10px;
      }

      .replay-controls {
        flex-direction: column;
        align-items: stretch;
      }

      .speed-controls {
        margin-left: 0;
      }
    }
  </style>
</head>
<body>
  <div class="replay-container">
    <header class="replay-header">
      <h1>üé¨ Humanity Badge - Verified Human Typing</h1>
      <div class="replay-info">
        <span id="site-info"></span>
        <span id="duration-info"></span>
      </div>
      <div id="verification-badge" class="verification-badge"></div>
    </header>

    <div class="replay-controls">
      <button id="play-btn">‚ñ∂Ô∏è Play</button>
      <button id="pause-btn" disabled>‚è∏Ô∏è Pause</button>
      <button id="reset-btn">‚èπÔ∏è Reset</button>
      <div class="speed-controls">
        <label>Speed:</label>
        <select id="speed-select">
          <option value="0.5">0.5x</option>
          <option value="1" selected>1x</option>
          <option value="2">2x</option>
          <option value="4">4x</option>
          <option value="8">8x</option>
        </select>
      </div>
    </div>

    <div class="progress-container">
      <div class="progress-bar">
        <div id="progress-fill"></div>
      </div>
      <div class="time-info">
        <span id="current-time">0s</span> / <span id="total-time">0s</span>
      </div>
    </div>

    <div class="replay-area">
      <div class="textarea-container">
        <textarea id="replay-textarea" readonly></textarea>
        <div id="cursor"></div>
      </div>
    </div>

    <div class="replay-stats">
      <div class="stat">
        <label>Characters:</label>
        <span id="char-count">0</span>
      </div>
      <div class="stat">
        <label>Words:</label>
        <span id="word-count">0</span>
      </div>
      <div class="stat">
        <label>WPM:</label>
        <span id="wpm">0</span>
      </div>
    </div>

    <footer class="replay-footer">
      <div class="footer-info">
        This replay was created with the Humanity Badge browser extension<br>
        Verify authentic human typing on any website
      </div>
      <a href="https://github.com/humanitybadge/extension" class="get-extension-btn" target="_blank">
        Get Humanity Badge Extension
      </a>
    </footer>
  </div>

  <!-- Embedded recording data (will be replaced by background.js) -->
  <script id="recording-data" type="application/json">
    {{RECORDING_DATA}}
  </script>

  <!-- Standalone replay player -->
  <script>
    class StandaloneReplayPlayer {
      constructor() {
        this.recording = null;
        this.currentEventIndex = 0;
        this.isPlaying = false;
        this.isPaused = false;
        this.startTime = null;
        this.pausedTime = 0;
        this.speed = 1;

        this.textarea = document.getElementById('replay-textarea');
        this.cursor = document.getElementById('cursor');
        this.progressFill = document.getElementById('progress-fill');

        this.init();
      }

      init() {
        // Load recording from embedded data
        try {
          const dataScript = document.getElementById('recording-data');
          if (!dataScript || !dataScript.textContent.trim()) {
            this.showError('No recording data found in this file');
            return;
          }

          this.recording = JSON.parse(dataScript.textContent);
          this.setupReplay();
          this.setupControls();
        } catch (error) {
          this.showError('Failed to load recording: ' + error.message);
        }
      }

      setupReplay() {
        // Set initial state
        this.textarea.value = this.recording.initialValue || '';
        this.textarea.placeholder = this.recording.placeholder || '';

        // Update info
        document.getElementById('site-info').textContent = `From: ${this.recording.domain || 'Unknown'}`;
        document.getElementById('duration-info').textContent = `Duration: ${Math.round(this.recording.duration / 1000)}s`;
        document.getElementById('total-time').textContent = Math.round(this.recording.duration / 1000) + 's';

        // Show verification status
        const verification = this.recording.verification || {};
        const badge = document.getElementById('verification-badge');

        if (verification.isAuthentic) {
          badge.className = 'verification-badge verified';
          badge.textContent = `‚úì Verified Human - ${verification.wpm} WPM`;
        } else {
          badge.className = 'verification-badge failed';
          badge.textContent = `‚ùå ${verification.reason || 'Verification Failed'}`;
        }

        this.updateStats();
      }

      setupControls() {
        document.getElementById('play-btn').addEventListener('click', () => this.play());
        document.getElementById('pause-btn').addEventListener('click', () => this.pause());
        document.getElementById('reset-btn').addEventListener('click', () => this.reset());

        document.getElementById('speed-select').addEventListener('change', (e) => {
          this.speed = parseFloat(e.target.value);
        });
      }

      play() {
        if (!this.recording) return;

        this.isPlaying = true;
        this.isPaused = false;
        this.startTime = Date.now() - this.pausedTime;

        document.getElementById('play-btn').disabled = true;
        document.getElementById('pause-btn').disabled = false;

        this.cursor.style.display = 'block';
        this.playLoop();
      }

      pause() {
        this.isPaused = true;
        this.isPlaying = false;
        this.pausedTime = Date.now() - this.startTime;

        document.getElementById('play-btn').disabled = false;
        document.getElementById('pause-btn').disabled = true;

        this.cursor.style.display = 'none';
      }

      reset() {
        this.isPlaying = false;
        this.isPaused = false;
        this.currentEventIndex = 0;
        this.pausedTime = 0;
        this.startTime = null;

        this.textarea.value = this.recording.initialValue || '';
        this.cursor.style.display = 'none';
        this.progressFill.style.width = '0%';

        document.getElementById('play-btn').disabled = false;
        document.getElementById('pause-btn').disabled = true;
        document.getElementById('current-time').textContent = '0s';

        this.updateStats();
      }

      playLoop() {
        if (!this.isPlaying || this.isPaused) return;

        const elapsed = (Date.now() - this.startTime) * this.speed;
        const events = this.recording.events || [];

        // Process all events that should have happened by now
        while (this.currentEventIndex < events.length &&
               events[this.currentEventIndex].timestamp <= elapsed) {

          const event = events[this.currentEventIndex];
          this.processEvent(event);
          this.currentEventIndex++;
        }

        // Update progress
        const progress = Math.min(elapsed / this.recording.duration * 100, 100);
        this.progressFill.style.width = progress + '%';
        document.getElementById('current-time').textContent = Math.round(elapsed / 1000) + 's';

        // Update cursor position
        this.updateCursorPosition();

        // Update stats
        this.updateStats();

        // Check if finished
        if (this.currentEventIndex >= events.length) {
          this.isPlaying = false;
          document.getElementById('play-btn').disabled = false;
          document.getElementById('pause-btn').disabled = true;
          this.cursor.style.display = 'none';
          return;
        }

        // Continue loop
        requestAnimationFrame(() => this.playLoop());
      }

      processEvent(event) {
        if (event.type === 'input') {
          this.textarea.value = event.value || '';

          // Set cursor position if available
          if (typeof event.selectionStart === 'number') {
            this.textarea.selectionStart = event.selectionStart;
            this.textarea.selectionEnd = event.selectionEnd;
          }
        }
      }

      updateCursorPosition() {
        const textarea = this.textarea;
        const cursorPos = textarea.selectionStart || 0;

        const textBeforeCursor = textarea.value.substring(0, cursorPos);
        const lines = textBeforeCursor.split('\n').length;
        const lineHeight = 20;

        this.cursor.style.left = '15px';
        this.cursor.style.top = (15 + (lines - 1) * lineHeight) + 'px';
      }

      updateStats() {
        const text = this.textarea.value;
        const charCount = text.length;
        const wordCount = text.trim().split(/\s+/).filter(word => word.length > 0).length;

        // Calculate current WPM based on elapsed time
        let wpm = 0;
        if (this.isPlaying && this.startTime) {
          const elapsedMinutes = ((Date.now() - this.startTime) * this.speed) / 60000;
          wpm = Math.round(wordCount / Math.max(elapsedMinutes, 0.1));
        } else if (this.recording.verification && this.recording.verification.wpm) {
          wpm = this.recording.verification.wpm;
        }

        document.getElementById('char-count').textContent = charCount;
        document.getElementById('word-count').textContent = wordCount;
        document.getElementById('wpm').textContent = wpm;
      }

      showError(message) {
        document.querySelector('.replay-container').innerHTML = `
          <div class="error">
            <h2>Error</h2>
            <p>${message}</p>
          </div>
        `;
      }
    }

    // Initialize when DOM is ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', () => new StandaloneReplayPlayer());
    } else {
      new StandaloneReplayPlayer();
    }
  </script>
</body>
</html>
